#include "chip8.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define ASSERT(ptr, msg) do { \
        if (ptr == NULL) { \
            fprintf(stderr, "assert error: %s at %d\n", msg, __LINE__); \
            exit(1); \
        } \
    } while (0)

static u8 fontSet[] = {
    0xF0, 0x90, 0x90, 0x90, 0xF0,
    0x20, 0x60, 0x20, 0x20, 0x70,
    0xF0, 0x10, 0xF0, 0x80, 0xF0,
    0xF0, 0x10, 0xF0, 0x10, 0xF0,
    0x90, 0x90, 0xF0, 0x10, 0x10,
    0xF0, 0x80, 0xF0, 0x10, 0xF0,
    0xF0, 0x80, 0xF0, 0x90, 0xF0,
    0xF0, 0x10, 0x20, 0x40, 0x40,
    0xF0, 0x90, 0xF0, 0x90, 0xF0,
    0xF0, 0x90, 0xF0, 0x10, 0xF0,
    0xF0, 0x90, 0xF0, 0x90, 0x90,
    0xE0, 0x90, 0xE0, 0x90, 0xE0,
    0xF0, 0x80, 0x80, 0x80, 0xF0,
    0xE0, 0x90, 0x90, 0x90, 0xE0,
    0xF0, 0x80, 0xF0, 0x80, 0xF0,
    0xF0, 0x80, 0xF0, 0x80, 0x80
};

chip8_vm *Chip8_New(const u8 *prog, const long size)
{
    chip8_vm *vm = malloc(sizeof(chip8_vm));
    ASSERT(vm, "vm malloc");

    memset(vm->ram, 0, RAM_SZ);
    memcpy(vm->ram, fontSet, sizeof(fontSet));
    memcpy(vm->ram + 0x200, prog, size);
    vm->_stack = (u16 *) &vm->ram[STACK_OFF];
    vm->screen = &vm->ram[SCREEN_OFF];
    vm->_resSz = 0x200;
    vm->pc = 0x200;
    vm->sp = 0;

    return vm;
}
